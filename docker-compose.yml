services:
  fedora:
    image: fcrepo/fcrepo:6-tomcat9
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${FEDORA_LOGGROUP}"
        awslogs-create-group: "true"
    environment:
      - CATALINA_OPTS=${FEDORA_OPTIONS}
    healthcheck:
      test: curl --fail -s http://fedoraAdmin:fedoraAdmin@localhost:8080/fcrepo/rest/fcr:systeminfo || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 3
    restart: always
  solr:
    image: solr:9
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${SOLR_LOGGROUP}"
        awslogs-create-group: "true"
    volumes:
      - ./solr/conf:/opt/solr/avalon_conf
      - /srv/solr_data:/var/solr
      - /srv/solr_backups:/backups
    command:
      - solr-precreate
      - avalon
      - /opt/solr/avalon_conf
    environment:
      - SOLR_MODULES=analysis-extras,extraction
    healthcheck:
      test: curl --fail -s http://localhost:8983/ || exit 1
      interval: 1m30s
      timeout: 10s
      retries: 3
    restart: always
  jobs:
    image: mcuadros/ofelia:latest
    volumes:
      - ./jobs.ini:/etc/ofelia/config.ini
      - /var/run/docker.sock:/var/run/docker.sock
    restart: always
  hls:
    image: avalonmediasystem/nginx:noble
    depends_on:
      - avalon
    build:
      context: ./nginx
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${HLS_LOGGROUP}"
        awslogs-create-group: "true"
    environment:
      - AVALON_DOMAIN=http://avalon:3000
      - AVALON_STREAMING_BUCKET
      - AVALON_STREAMING_BUCKET_URL=http://$AVALON_STREAMING_BUCKET.s3.amazonaws.com/
      - VOD_MODE=remote
    ports:
      - "8880:80"
    restart: always
  cache:
    image: nginx
    volumes:
      - ./cache.conf:/etc/nginx/conf.d/nginx.conf
    ports:
      - "80:80"
    restart: always
  avalon: &avalon
    image: ${AVALON_DOCKER_REPO}:${AVALON_REV:-latest}
    command: bash -c "bundle exec rake db:migrate && bundle exec rails server -b 0.0.0.0"
    env_file:
      - .env
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${AVALON_LOGGROUP}"
        awslogs-create-group: "true"
    depends_on:
      - fedora
      - solr
    environment:
      - APP_NAME
      - AWS_REGION
      - SECRET_KEY_BASE
      - DATABASE_URL=${DATABASE_URL}
      - SETTINGS__DOMAIN
      - SETTINGS__EMAIL__MAILER=aws_sdk
      - SETTINGS__EMAIL__COMMENTS
      - SETTINGS__EMAIL__NOTIFICATION
      - SETTINGS__EMAIL__SUPPORT
      - ENCODE_WORK_DIR=/tmp
      - FEDORA_BASE_PATH
      - FEDORA_NAMESPACE=avalon
      - FEDORA_URL=http://fedoraAdmin:fedoraAdmin@fedora:8080/fcrepo/rest
      - SETTINGS__FFMPEG__PATH=/usr/bin/ffmpeg
      - MASTER_FILE_PATH
      - MASTER_FILE_STRATEGY=delete
      - MEDIAINFO_PATH=/usr/bin/mediainfo
      - PIDFILE=tmp/pids/server.pid
      - PUMA_STATE_PATH=tmp/puma.state
      - RAILS_ADDITIONAL_HOSTS=avalon
      - RAILS_ENV=production
      - RAILS_SERVE_STATIC_FILES=true
      - SETTINGS__REDIS__URL=redis://${ELASTICACHE_HOST}:6379/0
      - SMTP_ADDRESS
      - SMTP_AUTHENTICATION
      - SMTP_DOMAIN
      - SMTP_ENABLE_STARTTLS_AUTO
      - SMTP_OPENSSL_VERIFY_MODE
      - SMTP_PASSWORD
      - SMTP_PORT
      - SMTP_USER_NAME
      - SOLR_URL=http://solr:8983/solr/avalon
      - SETTINGS__ENCODING__ENGINE_ADAPTER
      - SETTINGS__ENCODING__MEDIA_CONVERT_ROLE
      - SETTINGS__ENCODING__DERIVATIVE_BUCKET
      - SETTINGS__ENCODING__PRESETS_PATH
      - SETTINGS__STREAMING__CONTENT_PATH=/
      - SETTINGS__STREAMING__SERVER=nginx
      - SETTINGS__TIMELINER__TIMELINER_URL
      - SYSTEM_GROUPS=administrator,group_manager,manager
      - SECRET_KEY_BASE=${SECRET_KEY_BASE}
      - Z3950_ATTRIBUTE
      - Z3950_DATABASE
      - Z3950_HOST
      - Z3950_PORT
      - SETTINGS__ACTIVE_STORAGE__SERVICE
      - SETTINGS__ACTIVE_STORAGE__BUCKET
    healthcheck:
      test: curl --fail -s http://localhost:3000/ || exit 1
      interval: 2m30s
      timeout: 10s
      retries: 3
    restart: always
  worker:
    <<: *avalon
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "${WORKER_LOGGROUP}"
        awslogs-create-group: "true"
    command: bundle exec sidekiq -C config/sidekiq.yml
    healthcheck:
      disable: true

